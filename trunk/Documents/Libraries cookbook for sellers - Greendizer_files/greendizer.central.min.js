(function(){window.greendizer=window.greendizer||{};var a=window.greendizer;a.central=a.central||{};a.central.widgets=a.central.widgets||{};a.central.Context=function(){var e,g=function(){var b=this,i=sellerReady=loadingLocalization=localizationReady=!1,f={oAuthClientId:a.central.environment.OAUTH_CLIENT_ID,oAuthRedirectUri:a.central.environment.OAUTH_REDIRECT_URI,oAuthScopes:"read_account read_invoices read_messages read_applications"},e=new a.oauth.BuyerApplication(f),d=new a.oauth.SellerApplication(f),
h,c={},g,j=!1,o=0,n={en:["en-US"],fr:["fr-FR"]};this.sleepModeWatchers=new a.base.FunctionCollection;this.timerTickWatchers=new a.base.FunctionCollection;var m=!1;this.isSleeping=function(){return j};this.isNotificationsOn=function(){return!window.webkitNotifications||0!=window.webkitNotifications.checkPermission()?!1:m};this.setNotificationsOn=function(b){b&&window.webkitNotifications?0!=window.webkitNotifications.checkPermission()?window.webkitNotifications.requestPermission(function(){0==window.webkitNotifications.checkPermission()&&
(m=!0);$("#user-surface-notifs").attr("src",a.central.environment.STATIC_URL+"images/notifs-black.png")}):m=!0:m=!1};this.getRunningApplication=function(){return e};this.getBuyer=function(){return e.getUser()};this.getSeller=function(){return d&&d.getUser()};var l=function(){try{return b.getBuyer()}catch(a){}try{return b.getSeller()}catch(c){}},t=function(){e.init(function(b){b&&(i=!0,s(),sellerReady&&localizationReady&&q())},!0)},u=function(){d.init(function(b){b||(d=null);sellerReady=!0;i&&localizationReady&&
q()},!1)},s=function(){l().getSettings(function(){var b=l().getSettings();v(b.getLanguage(),b.getRegion(),function(){localizationReady=!0;i&&sellerReady&&q()})})},q=function(){a.central.widgets.LoadingIndicator.getInstance();h.show();$("#content").gdCentral();b.postMessage("state",{state:"authenticated"})},w=function(){try{for(var a=window.name.split("&"),d=0;d<a.length;d++){var f=a[d].split("=");c[f[0]]=unescape(f[1])}window.name="";c["native"]=/^(true|1)$/i.test(c["native"]);if(!b.isStandAloneMode()&&
!c.origin)return console.error("Greendizer: Missing origin. Please report the error."),!1;c.origin&&(c.origin=unescape(c.origin))}catch(e){return console.error("Greendizer: missing parameters. Please report the error."),!1}return!0};this.findLocalizedString=function(b){var a;try{a=eval("greendizer.localization.currentCulture."+b)||eval("greendizer.localization.currentUICulture."+b)}catch(c){}if(a)return a;console.warn(String.format("Could not find '{0}' in the current language and culture files.",
b));return b};this.formatNumber=function(b,a){var c=isNaN(a)?numberFormat:$.extend({},numberFormat,{precision:Math.min(5,a)});return Number.format(b,c)};this.formatCurrency=function(b,a,c){a=$.extend({},currencyFormat,{precision:isNaN(c)?numberFormat.precision:Math.min(5,c),symbol:this.findLocalizedString("Currencies")[a].Symbol});return Number.toCurrency(b,a)};this.isStandAloneMode=function(){return window==window.parent};this.isNative=function(){return c["native"]};var v=function(d,f,e){if(!d||
!f){var d=d||"en",f=f||"en-US",h=/^(\w{2})(?:-(\w{2}))?$/i.exec(c.lang);h&&h[1]in n&&(d=h[1],f=h[2]&&0<=$.inArray(c.lang,n[d])?c.lang:n[h[1]][0])}for(var d=[d,f],i=d.length,f=function(){i--;i||(numberFormat={precision:b.findLocalizedString("FloatPrecision"),decimalSep:b.findLocalizedString("DecimalSeparator"),thousandSep:b.findLocalizedString("ThousandSeparator")},currencyFormat=$.extend(numberFormat,{pattern:b.findLocalizedString("CurrencySymbolPosition")}),localizationReady=!0,e&&e())},h=0;h<d.length;h++){var j=
String.format("{0}locales/{1}.loc.js",a.central.environment.STATIC_URL,d[h]);$.getScript(j,f)}};this.postMessage=function(a,d){if(b.isStandAloneMode()){if("navigation"===a)!d.target||"_self"===d.target?window.location.href=d.url:window.open(d.url,d.target)}else d=$.extend(d||{},{id:c.id,type:a}),"origin"in c&&window.parent.postMessage(JSON.stringify(d),c.origin)};var r=function(){g&&window.clearInterval(g);j=!0;b.sleepModeWatchers.fire(j)};(function(){if(w()){var d=$("body");(b.isStandAloneMode()||
b.isNative())&&$("body").addClass("standalone");h=$("<img id='logo'/>").hide().attr("title","Greendizer").attr("src",a.central.environment.STATIC_URL+"images/"+(d.hasClass("standalone")?"logo.png":"logowhite.png")).appendTo("body");$("<img id='main-loader'/>").attr("src",a.central.environment.STATIC_URL+"images/"+(d.hasClass("standalone")?"loader.gif":"loaderwhite.gif")).appendTo("body");!b.isStandAloneMode()&&$(window).click(function(){b.postMessage("state",{state:"sleep"})});t();u();window.setInterval(function(){o++;
!j&&b.timerTickWatchers.fire(1E3*o)},1E3);$(window).bind("mousemove",function(){g&&window.clearInterval(g);j&&(j=!1,b.sleepModeWatchers.fire(j),o++,b.timerTickWatchers.fire(o));g=window.setInterval(r,3E5)});g=window.setInterval(r,3E5)}})()};return new function(){this.getInstance=function(){if(!e)e=new g,e.constructor=null;return e}}}();a.central.environment={DEBUG:!1,STATIC_URL:"/static/",DEFAULT_URL:"https://www.greendizer.com/",LOGOUT_URL:"https://services.greendizer.com/logout/",OAUTH_CLIENT_ID:"781102",
OAUTH_REDIRECT_URI:"https://central.greendizer.com/oauth_callback.html",SETTINGS_URL:"https://services.greendizer.com/settings/",CREATOR_ID:"2",CREATOR_URL:"https://creator.greendizer.com/",BUYERS_INVOICES_ID:"739107",SELLERS_INVOICES_ID:"781104",BUYERS_INVOICES_URL:"https://invoices.greendizer.com/buyers/",SELLERS_INVOICES_URL:"https://invoices.greendizer.com/sellers/",BLACKLISTED_APPS:["1002"],DEFAULT_USER_AVATAR:"https://greendizer-public.s3.amazonaws.com/avatars/userdefault.png",DEFAULT_COMPANY_LOGO:"https://greendizer-public.s3.amazonaws.com/companies/companydefault.png"};
a.central.preinstalled={buyers:{invoices:{id:a.central.environment.BUYERS_INVOICES_ID,name:"Invoices",description:"Manage the invoices you have received.",largeLogo:String.format("{0}applications/a{1}.128.png","https://greendizer-public.s3.amazonaws.com/",a.central.environment.BUYERS_INVOICES_ID),website:a.central.environment.BUYERS_INVOICES_URL}},sellers:{invoices:{id:a.central.environment.SELLERS_INVOICES_ID,name:"Invoices",description:"Manage your customers' invoices.",largeLogo:String.format("{0}applications/a{1}.128.png",
"https://greendizer-public.s3.amazonaws.com/",a.central.environment.SELLERS_INVOICES_ID),website:a.central.environment.SELLERS_INVOICES_URL},creator:{id:a.central.environment.CREATOR_ID,name:"Creator",description:"Online invoice creator",largeLogo:String.format("{0}applications/a{1}.128.png","https://greendizer-public.s3.amazonaws.com/",a.central.environment.CREATOR_ID),website:a.central.environment.CREATOR_URL}}};a.central.widgets.ActivityMonitor=function(e,g){var b=this,i=e.aggregator,f=e.label,
k=e.notificationEnabled,d=e.notificationMsg,h=null,c;if(!i)throw Error("'aggregator' attribute is required.");if(!f)throw Error("'label' attribute is required.");if(k&&!d)throw Error("'notificationMsg' attribute is required when notificationEnabled is true.");a.central.widgets.WidgetBase.call(this,e,g);var p=this._init;this._init=function(){p.call(this);$('<span class="label"/>').html(f).appendTo(this.element);c=$('<span class="count"/>').appendTo(this.element);j();a.central.Context.getInstance().timerTickWatchers.add(new a.base.FunctionPointer(function(b){!(b%
3E4)&&j()},b))};var j=function(){i.loadInfo(function(){var a=i.getCount();a!==h&&(b.isNotificationsOn()&&k&&null!=h&&window.webkitNotifications.createNotification("https://www.greendizer.com/favicon.ico","Greendizer",d).show(),c.removeClass("negative").html(b.formatNumber(a,0)),h=a)},function(){c.addClass("negative")})};(function(){b._init();a.central.Context.getInstance().sleepModeWatchers.add(new a.base.FunctionPointer(function(b){!b&&j()},b))})()};$.widget.bridge("gdActivityMonitor",a.central.widgets.ActivityMonitor);
a.central.widgets.Central=function(e,g){var b=this;a.central.widgets.WidgetBase.call(this,e,g);var i=this._init;this._init=function(){i.call(this);var e=b.getBuyer(),d=b.getSeller();$("<div/>").gdUserBadge().appendTo(this.element);var h=$('<div id="launchpads"/>').appendTo(this.element);(b.isStandAloneMode()||b.isNative())&&$("<div/>").gdNotificationBar().appendTo(h);h=$('<div id="pads"/>').appendTo(h);$("<div/>").gdLaunchpad({title:b.findLocalizedString("Launchpad.BuyerTitle"),collection:e.getApplications().getAll(),
scope:"buyers"}).appendTo(h);var c=$('<div id="activity"/>').appendTo(this.element);if(b.isStandAloneMode()||b.isNative()){var g=$('<div id="gdNews"/>').addClass("tweetContainer").appendTo(c);$('<div id="tweet-ticker"/>').appendTo(g);$("#tweet-ticker").tweet({username:"greendizer",page:1,avatar_size:24,count:5,retweets:!1,template:"{avatar}{text} ({time})"}).bind("loaded",function(){var b=$(this).find(".tweet_list"),a=function(){setTimeout(function(){b.find("li:first").animate({marginTop:"-110px"},
500,function(){$(this).detach().appendTo(b).removeAttr("style")});a()},15E3)};a()})}var c=$('<div id="activities"/>').appendTo(c),c=$('<div id="buyer-activities"/>').appendTo(c),j=$("<div class='invoices'/>").append($("<h3/>").html(b.findLocalizedString("Activities.Invoices"))).appendTo(c),o=$("<div class='threads'/>").append($("<h3/>").html(b.findLocalizedString("Activities.Threads"))).appendTo(c);e.getEmails().getAll().populate(function(){for(var d=e.getEmails().getAll().getResources(),c=new a.dal.Aggregator,
h=new a.dal.Aggregator,i=new a.dal.Aggregator,g=new a.dal.Aggregator,l=0;l<d.length;l++)c.add(d[l].getThreads().getAll()),h.add(d[l].getThreads().getUnread()),i.add(d[l].getInvoices().getAll()),g.add(d[l].getInvoices().getDue());f(o,c,b.findLocalizedString("Activities.Buyer.AllThreadsCount"),!0,b.findLocalizedString("Notifications.Buyer.NewMessage"));f(o,h,b.findLocalizedString("Activities.Buyer.UnreadThreadsCount"));f(j,i,b.findLocalizedString("Activities.Buyer.AllInvoicesCount"),!0,b.findLocalizedString("Notifications.Buyer.NewInvoice"));
f(j,g,b.findLocalizedString("Activities.Buyer.UnpaidInvoicesCount"),!0,b.findLocalizedString("Notifications.Buyer.NewPaymentLate"))});if(d){$("<div/>").gdLaunchpad({title:b.findLocalizedString("Launchpad.SellerTitle"),collection:d.getApplications().getAll(),scope:"sellers"}).insertBefore(h.children()[0]);var h=$('<div id="seller-activities"/>').insertBefore(c),n=$("<div class='invoices'/>").append($("<h3/>").html(b.findLocalizedString("Activities.Invoices"))).appendTo(h),h=$("<div class='threads'/>").append($("<h3/>").html(b.findLocalizedString("Activities.Threads"))).appendTo(h),
c=new a.dal.Aggregator,g=new a.dal.Aggregator;c.add(d.getThreads().getAll());g.add(d.getThreads().getUnread());var m=new a.dal.Aggregator,l=new a.dal.Aggregator;d.getEmails().getAll().populate(function(){for(var a=d.getEmails().getAll().getResources(),c=0;c<a.length;c++)m.add(a[c].getInvoices().getAll()),l.add(a[c].getInvoices().getDue());f(n,m,b.findLocalizedString("Activities.Seller.AllInvoicesCount"));f(n,l,b.findLocalizedString("Activities.Seller.UnpaidInvoicesCount"),!0,b.findLocalizedString("Notifications.Seller.NewPaymentLate"))});
f(h,c,b.findLocalizedString("Activities.Seller.AllThreadsCount"));f(h,g,b.findLocalizedString("Activities.Seller.UnreadThreadsCount"),!0,b.findLocalizedString("Notifications.Seller.NewThread"))}else $("<div class='launchpad'/>").hide().insertBefore(h.children()[0]);$("<div/>").gdFooterLinks().appendTo(this.element)};var f=function(b,a,f,c,e){c=c||!1;return $("<div/>").gdActivityMonitor({aggregator:a,label:f,notificationEnabled:c,notificationMsg:e}).appendTo(b)};b._init()};$.widget.bridge("gdCentral",
a.central.widgets.Central);a.central.widgets.FooterLinks=function(e,g){var b=this,i=a.central.Context.getInstance();a.central.widgets.WidgetBase.call(this,e,g);var f=this._init;this._init=function(){f.call(this);this.element.attr("id","copyrights");if(b.isStandAloneMode()||b.isNative()){var a=$('<div id="leftFooter"/>').appendTo(this.element);$("<span/>").html(this.findLocalizedString("Footer.News")).appendTo(a)}var a=$("<ul/>").appendTo(this.element),d=String.format(this.findLocalizedString("Footer.Copyright"),
(new Date).getFullYear());$("<li/>").html(d).appendTo(a);var d={"/features/":"Features","/pricing/":"Pricing","/docs/":"Docs","/company/":"Company"},h;for(h in d)$("<li/>").attr("data-href",h).addClass("link").html(this.findLocalizedString("Footer."+d[h])).appendTo(a).click(function(){var b=$(this);i.postMessage("navigation",{url:b.attr("data-href"),window:b.attr("target")});return!1})};b._init()};$.widget.bridge("gdFooterLinks",a.central.widgets.FooterLinks);a.central.widgets.Launchpad=function(e,
g){var b=this,i=e.title,f=e.collection,k=e.scope,d=[];if(!i)throw Error("'title' attribute is required.");if(!f)throw Error("'collection' attribute is required.");if(!k)throw Error("'scope' attribute is required.");a.central.widgets.WidgetBase.call(this,e,g);var h=this._init,c=function(c){c.getID()===b.getRunningApplication().getID()||-1!==$.inArray(c.getID(),a.central.environment.BLACKLISTED_APPS)||($("<a/>").appendTo(b.element).gdLaunchpadApp({resource:c,parent:b}),d.push(c.getID()))},p=function(a){b.element.find(String.format("[name='{0}']",
a.getID())).remove()};this._init=function(){h.call(this);this.element.empty().addClass("launchpad");$("<h2/>").html(i).appendTo(this.element);f.addedEventWatchers.add(new a.base.FunctionPointer(c,this));f.removedEventWatchers.add(new a.base.FunctionPointer(p,this));for(var e=f.getResources(),g=0;g<e.length;g++)c(e[g]);f.populate(function(){var b=a.central.preinstalled[k],f;for(f in b){var e=b[f];-1===$.inArray(e.id,d)&&c({getID:function(){return e.id},getName:function(){return e.name},getLargeLogoURL:function(){return e.largeLogo},
getWebsiteURL:function(){return e.website},getDescription:function(){return e.description}})}});a.central.Context.getInstance().timerTickWatchers.add(new a.base.FunctionPointer(function(b){!(b%6E4)&&f.refresh()},b))};(function(){b._init();a.central.Context.getInstance().sleepModeWatchers.add(new a.base.FunctionPointer(function(b){!b&&f.refresh()},b))})()};$.widget.bridge("gdLaunchpad",a.central.widgets.Launchpad);a.central.widgets.LaunchpadApp=function(e,g){var b=this,i=e.resource;if(!i)throw Error("'resource' attribute is required.");
a.central.widgets.WidgetBase.call(this,e,g);var f=this._init;this._init=function(){f.call(this);this.element.attr("target","_self").attr("title",i.getDescription()).attr("href",i.getWebsiteURL());this.element.attr("name",i.getID()).addClass("app").click(function(){return!b.isStandAloneMode()?(a.central.Context.getInstance().postMessage("navigation",{url:b.element.attr("href"),window:b.element.attr("target")}),!1):!0});$("<img/>").attr("src",i.getLargeLogoURL()).appendTo(this.element);$("<div/>").html(i.getName()).appendTo(this.element);
this.element.tipTip({defaultPosition:"left"})};b._init()};$.widget.bridge("gdLaunchpadApp",a.central.widgets.LaunchpadApp);a.central.widgets.LoadingIndicator=function(){var a=void 0,g=function(){var b=void 0,a=0,f=!1,e=$("#main-loader"),d=this;$(window).ajaxStart(function(){d.show()}).ajaxStop(function(){d.hide()});this.show=function(){a++;f||(f=!0,b=window.setTimeout(function(){b=void 0;e.show()},10))};this.hide=function(){1===a?(b&&window.clearTimeout(b),a=0,f=!1,e.hide()):1<a&&a--}};return new function(){this.getInstance=
function(){if(!a)a=new g,a.constructor=null;return a}}}();a.central.widgets.NotificationBar=function(e,g){var b=this,i=null,f=0;a.central.widgets.WidgetBase.call(this,e,g);var k=this._init,d=function(d,c,e,g,k){f++;var g=g||"#",k=k||"",n=d.getEvents().search("code=="+c+""),m=$("<a/>").attr("href",g).html(e).click(function(){if(k)return k(),!1;if(!b.isStandAloneMode()){var c=$(this);a.central.Context.getInstance().postMessage("navigation",{url:c.attr("href"),window:c.attr("target")});return!1}return!0}).appendTo($("<li/>").appendTo(i));
n.loadInfo(function(){0<n.getCount()?(f--,m.parent().addClass("ok"),m.attr("href","#")):m.parent().addClass("ko")})};this._init=function(){k.call(this);var e=this.element.attr("id","notificationBar");$("<h2/>").html(b.findLocalizedString("NotificationBar.Title")).appendTo(this.element);i=$("<ul/>").attr("id","actionsList").appendTo(e);var e=b.getBuyer(),c=b.getSeller();d(e,"SECURITY.PASSWORD.CHANGE",b.findLocalizedString("NotificationBar.Steps.Password"),a.central.environment.SETTINGS_URL+"security/",
null);d(e,"PROFILE.GENERAL.CHANGE",b.findLocalizedString("NotificationBar.Steps.GeneralProfile"),a.central.environment.SETTINGS_URL,null);d(e,"PROFILE.AVATAR.CHANGE",b.findLocalizedString("NotificationBar.Steps.Avatar"),a.central.environment.SETTINGS_URL,null);c&&(d(c,"COMPANY.LOGO.CHANGE",b.findLocalizedString("NotificationBar.Steps.Logos"),a.central.environment.SETTINGS_URL+"company/",null),d(c,"COMPANY.PROFILE.CHANGE",b.findLocalizedString("NotificationBar.Steps.CompanyProfile"),a.central.environment.SETTINGS_URL+
"company/",null),d(c,"COMPANY.STAFF.ADD",b.findLocalizedString("NotificationBar.Steps.Staff"),a.central.environment.SETTINGS_URL+"company/users/",null),d(c,"INVOICE.SUBMIT",b.findLocalizedString("NotificationBar.Steps.InvoiceSend"),a.central.environment.CREATOR_URL,null))};b._init()};$.widget.bridge("gdNotificationBar",a.central.widgets.NotificationBar);a.central.widgets.UserBadge=function(e,g){var b=this;a.central.widgets.WidgetBase.call(this,e,g);var i=this._init;this._init=function(){i.call(this);
this.element.attr("id","user-surface");var e=$("<div id='user-surface-avatar'/>").appendTo(this.element),g=$("<img id='user-surface-user-avatar'/>").hide().appendTo(e),d=$("<img id='user-surface-company-logo'/>").hide().appendTo(e),e=$("<div class='section'/>").appendTo(e);window.webkitNotifications&&$("<img class='clickable' id='user-surface-notifs'/>").attr("src",a.central.environment.STATIC_URL+(b.isNotificationsOn()?"images/notifs-black.png":"images/notifs-fade.png")).attr("title",b.findLocalizedString("UserBadge.Notifs")).click(function(){b.isNotificationsOn()?
b.setNotificationsOn(!1):b.setNotificationsOn(!0);var c=$("#user-surface-notifs");c&&(b.isNotificationsOn()?c.attr("src",a.central.environment.STATIC_URL+"images/notifs-black.png"):c.attr("src",a.central.environment.STATIC_URL+"images/notifs-fade.png"))}).appendTo(e).tipTip({defaultPosition:"bottom"});$("<img class='clickable' id='user-surface-settings'/>").attr("src",a.central.environment.STATIC_URL+"images/settings.png").attr("title",b.findLocalizedString("UserBadge.Settings")).click(function(){a.central.Context.getInstance().postMessage("navigation",
{url:a.central.environment.SETTINGS_URL});return!1}).appendTo(e).tipTip({defaultPosition:"bottom"});$("<img class='clickable' id='user-surface-logout'/>").attr("src",a.central.environment.STATIC_URL+"images/logout.png").attr("title",b.findLocalizedString("UserBadge.Logout")).click(function(){a.central.Context.getInstance().postMessage("navigation",{url:a.central.environment.LOGOUT_URL+"?next="+escape(a.central.environment.DEFAULT_URL)});return!1}).appendTo(e).tipTip({defaultPosition:"bottom"});var h=
$("<div id='user-surface-name'/>").hide().appendTo(this.element);this.getBuyer().load(function(){var c=b.getBuyer();g.attr("src",c.getAvatarURL()).error(function(){g.data("gdImageFallback")?g.data("gdImageFallback",!1):(g.attr("src",a.central.environment.DEFAULT_USER_AVATAR),g.data("gdImageFallback",!0))}).show();h.show().html(c.getFullname())});this.getBuyer().getCompany(function(){var c=b.getBuyer().getCompany();c?d.attr("src",c.getLargeLogoURL()).attr("title",c.getName()).error(function(){d.data("gdImageFallback")?
d.data("gdImageFallback",!1):(d.attr("src",a.central.environment.DEFAULT_COMPANY_LOGO),d.data("gdImageFallback",!0))}).show():d.remove()},function(){d.remove()})};b._init()};$.widget.bridge("gdUserBadge",a.central.widgets.UserBadge);a.central.widgets.WidgetBase=function(e,g){this.options=$.extend(this.defaults||{},e||{});this.element=$(g);this._init=function(){};this.getRunningApplication=function(){return a.central.Context.getInstance().getRunningApplication()};this.getBuyer=function(){return a.central.Context.getInstance().getBuyer()};
this.getSeller=function(){return a.central.Context.getInstance().getSeller()};this.formatNumber=function(b){return a.central.Context.getInstance().formatNumber(b,0)};this.findLocalizedString=function(b){return a.central.Context.getInstance().findLocalizedString(b)};this.isStandAloneMode=function(){return a.central.Context.getInstance().isStandAloneMode()};this.isNative=function(){return a.central.Context.getInstance().isNative()};this.isNotificationsOn=function(){return a.central.Context.getInstance().isNotificationsOn()};
this.setNotificationsOn=function(b){return a.central.Context.getInstance().setNotificationsOn(b)};this.option=function(a,e){if($.isPlainObject(a))this.options=$.extend(!0,this.options,a);else{if(a&&"undefined"===typeof e)return this._getData(a)||this.options[a];this._setData(a,e)||(this.options[a]=e)}return this};this._getData=function(){};this._setData=function(){}}})();
